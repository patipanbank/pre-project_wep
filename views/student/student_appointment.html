<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Student Appointment</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous">
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
        <link rel="stylesheet"
            href="/public/css/student/student_appointment.css">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
            rel="stylesheet">
    </head>

    <body>
        <nav><img id="imgnav" src="/public/img/Header-School-IT-MFU_Thai.png"
                alt></nav>

        <nav class="navbar navbar-light navbar-expand-lg"
            style="background-color: #253b6d;">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button"
                    data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link active" style="color: white;"
                                aria-current="page"
                                href="/student/homepage">HOME</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" style="color: white;"
                                href="/student/statusappointment">STATUS
                                APPOINTMENT</a>
                        </li>
                    </ul>
                </div>
                <div>
                    <button type="button" class="btn btn-danger"
                        onclick="logout()">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container mt-5">
            <div class="row">
                <div class="col-md-3">
                    <div style="text-align: center">
                        <img id="imgt" src alt="Profile Image"
                            style="width: 150px; display: block; margin-left: auto; margin-right: auto; margin-top: 20px;" />
                        <p id="prof-name" class="mt-2 mb-0 fs-6"></p>
                        <p id="prof-email" class="mt-2 mb-0 fs-6"></p>
                        <p id="prof-major" class="mt-2 mb-0 fs-6"></p>
                        <p id="prof-tel" class="mt-2 mb-0 fs-6"></p>
                    </div>
                </div>
                <div class="col-md-9 coltable">
                    <div class="table-responsive mt-3">
                        <label for="semester-select">Select Semester:</label>
                        <select id="semester-select" class="form-control">
                            <option value>Select Semester</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <label for="multi-date-input">Select Multiple
                            Dates:</label>
                        <input type="text" id="multi-date-input" />
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th scope="col"
                                        class="centered">Day/Time</th>
                                    <!-- Time slots will be populated here -->
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                <!-- Rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="circlewraper">
                <div class="rowcircle mt-5">
                    <div class="circle bg-success">
                    </div>
                    <p
                        style="font-weight: bold; margin-left: 5px;">Available</p>
                </div>
                <div class="rowcircle mt-5">
                    <div class="circle bg-danger">
                    </div>
                    <p
                        style="font-weight: bold; margin-left: 5px;">Unavailable</p>
                </div>
                <div class="rowcircle mt-5">
                    <div class="circle bg-warning">
                    </div>
                    <p style="font-weight: bold; margin-left: 5px;">Waiting</p>
                </div>
                <div class="rowcircle mt-5">
                    <div class="circle bg-secondary">
                    </div>
                    <p style="font-weight: bold; margin-left: 5px;">Leave</p>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script>

        
// loading image
$(document).ready(function () {
    // Existing code for fetching and displaying profile data
    const data_id = new URLSearchParams(window.location.search).get(
      "data_id"
    ); // Get data_id from URL
    // Fetch profile data for the given data_id
    fetch(`/data/images/${data_id}`)
      .then((response) => response.json())
      .then((data) => {
        if (data) {
          $("#imgt").attr("src", data.image);
          $("#prof-name").text(data.name);
          $("#prof-email").text(data.email);
          $("#prof-major").text(data.major);
          $("#prof-tel").text(data.tel);
        }
      })
      .catch((error) =>
        console.error("Error fetching profile data:", error)
      );
  });
  let currentWeekDates = [];
  document.addEventListener("DOMContentLoaded", function () {
    const data_id = new URLSearchParams(window.location.search).get("data_id"); // Get data_id from URL
    const currentYear = new Date().getFullYear();
    const dateInput = document.getElementById("multi-date-input");
    
    // Fetch all semesters
    fetch("/semester/all")
      .then((response) => response.json())
      .then((semesters) => {
        const semesterSelect = document.getElementById("semester-select");

        // Sort semesters by year and term to ensure proper order
        semesters.sort((a, b) => {
          if (a.year !== b.year) {
            return a.year - b.year;
          } else {
            return a.term - b.term;
          }
        });

        let defaultOptionSelected = false;

        semesters.forEach((semester) => {
          const option = document.createElement("option");
          option.value = semester.semester_id;
          option.textContent = `${semester.term}/${semester.year}`;
          semesterSelect.appendChild(option);

          // Set default option to Term 1 of the current year
          if (!defaultOptionSelected && semester.term === "1" && semester.year === currentYear) {
            option.selected = true;
            defaultOptionSelected = true;

            // Set date range based on the selected semester's start and end date
            setDateInputRange(semester.start_date, semester.end_date,semester.semester_id);
          }
        });

        semesterSelect.addEventListener("change", function () {
          const selectedSemester = semesters.find(semester => semester.semester_id === parseInt(semesterSelect.value));
          if (selectedSemester) {
            setDateInputRange(selectedSemester.start_date, selectedSemester.end_date,selectedSemester.semester_id);
          }
        });

        // If no Term 1 for current year is found, set the first semester as default
        if (!defaultOptionSelected && semesters.length > 0) {
          semesterSelect.options[0].selected = true;
          const firstSemester = semesters[0];
          setDateInputRange(firstSemester.start_date, firstSemester.end_date,firstSemester.semester_id);
        }
      })
      .catch((error) => console.error("Error fetching semesters:", error));

    // Function to initialize and set date input range with Flatpickr for multi-date selection
    function setDateInputRange(startDate, endDate, semester_id) {
      flatpickr(dateInput, {
        mode: "multiple",
        minDate: new Date(startDate).toISOString().split('T')[0],
        maxDate: new Date(endDate).toISOString().split('T')[0],
        dateFormat: "Y-m-d",
        disable: [
          function(date) {
            return (date.getDay() === 6 || date.getDay() === 0); // Disable weekends
          }
        ],
        onChange: function(selectedDates, dateStr, instance) {
          // If user is clearing the selection
          if (selectedDates.length === 0) {
            currentWeekDates = [];
            return;
          }
  
          // Get the most recently selected date
          const selectedDate = new Date(selectedDates[selectedDates.length - 1]);
          
          // Calculate Monday of the selected week
          const monday = new Date(selectedDate);
          monday.setHours(0, 0, 0, 0);
          
          // Adjust to Monday (1) if not already
          const day = monday.getDay();
          const diff = monday.getDate() - day + (day === 0 ? -6 : 1);
          monday.setDate(diff);
  
          // Generate array of weekdays (Mon-Fri)
          const weekDays = [];
          for (let i = 0; i < 5; i++) {
            const currentDate = new Date(monday);
            currentDate.setDate(monday.getDate() + i);
            weekDays.push(currentDate);
          }
          // console.log(weekDays);
          
          // Check if days are within allowed range
          const minDate = new Date(instance.config.minDate);
          const maxDate = new Date(instance.config.maxDate);
          // console.log(maxDate);
          
          const validWeekDays = weekDays.filter((day)=> {
            return day >= minDate && day <= maxDate; 
          }
          );
          // console.log(validWeekDays.map(day => day.toDateString()));
          
          // If the selected dates are from the current week, clear them all
          if (currentWeekDates.length > 0 && 
              weekDays[0].toDateString().split('T')[0] === currentWeekDates[0]) {
            instance.clear();
            currentWeekDates = [];
          } else {
            // Set all valid weekdays for the selected week
            // console.log(validWeekDays);
            
            instance.setDate(validWeekDays);
            
            currentWeekDates = validWeekDays.map(date => date.toDateString().split('T'));
            
            if (currentWeekDates.length > 0) {
              // console.log(currentWeekDates);
              
              generateSlots(data_id, semester_id, currentWeekDates[0], currentWeekDates[currentWeekDates.length-1]);
            }
          }
        }
      });
    }
});

  function formatTime(timeString) {
    const [hours, minutes] = timeString.split(":");
    return `${hours.padStart(2, "0")}:${minutes.padStart(2, "0")}`;
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { day: 'numeric', month: 'short' }; // e.g., "15 Jan"
    return date.toLocaleDateString('en-GB', options);
  }

  function generateSlots(data_id, semester_id, start_date, end_date) {
    if (!data_id || !semester_id) {
      console.error("Error: Missing data_id or semester_id");
      return;
    }

    fetch(`/api/timesclotsbyleave/${data_id}/${semester_id}/${start_date}/${end_date}`)
      .then((response) => response.json())
      .then((timeslots) => {
        const tableBody = $("#scheduleTableBody");
        const thead = $("thead tr");

        // Clear existing headers
        thead.empty();
        thead.append('<th scope="col">Day/Time</th>');

        // Create array of dates for the selected week
        const startDate = new Date(start_date);
        console.log(startDate);
        
        const dates = [];
        for (let i = 0; i < 5; i++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);
          dates.push(currentDate);
        }
        console.log(dates);
        
        // Map days to their corresponding dates
        const daysOfWeek = [
          { day: "Monday", date: dates[0] },
          { day: "Tuesday", date: dates[1] },
          { day: "Wednesday", date: dates[2] },
          { day: "Thursday", date: dates[3] },
          { day: "Friday", date: dates[4] }
        ];

        // Prepare time slots array and headers
        let timeSlots = [];
        timeslots.forEach((slot) => {
          const timeRange = `${formatTime(slot.start_time)}-${formatTime(slot.end_time)}`;
          if (!timeSlots.includes(timeRange)) {
            timeSlots.push(timeRange);
            thead.append(`<th scope="col">${timeRange}</th>`);
          }
        });

        // Clear existing rows
        tableBody.empty();

        // Create rows for each day with dates and add time slot data
        daysOfWeek.forEach(({day, date}) => {
          let row = `<tr><th scope="row">${day}<br>${formatDate(date)}</th>`;
          // console.log('Date : ',date);
          
          timeSlots.forEach((timeSlot) => {
            // Find timeslot data for the current day and time slot
            const slotData = timeslots.find(
              (slot) =>
                slot.dayofweek === day &&
                `${formatTime(slot.start_time)}-${formatTime(slot.end_time)}` === timeSlot
            );
        
            // Add cell for the time slot
            if (slotData) {
              row += `<td data-timeslots_id="${slotData.timeslots_id}" 
                         data-start_time="${slotData.start_time}" 
                         data-end_time="${slotData.end_time}" 
                         data-dayofweek="${slotData.dayofweek}" 
                         data-status="${slotData.status}" 
                         data-date="${date}"
                         >
                     </td>`;
            } else {
              // If there's no data for the time slot, add an empty cell
              row += `<td></td>`;
            }
          });
        
          row += "</tr>";
          tableBody.append(row);
        });
      })
      .catch((error) => console.error("Error fetching timeslots:", error));
  }
        function logout() {
            fetch('/logout', { method: 'POST' }) // Adjust the logout endpoint as needed
                .then(() => {
                    window.location.href = '/login'; // Redirect to login after logout
                })
                .catch(error => console.error('Error logging out:', error));
        }

    </script>
    </body>

</html>